---
apiVersion: flux.weave.works/v1beta1
kind: HelmRelease
metadata:
  name: nexus
  namespace: devops
  annotations:
    flux.weave.works/automated: "false"
spec:
  releaseName: digimind-nexus
  chart:
    repository: https://kubernetes-charts.storage.googleapis.com/
    name: sonatype-nexus
    version: 1.5.1
  values:
    replicaCount: 1

    nexus:
      imageName: quay.io/travelaudience/docker-nexus
      imageTag: 3.14.0
      imagePullPolicy: IfNotPresent
      env:
        - name: install4jAddVmParams
          value: "-Xms1200M -Xmx1200M -XX:MaxDirectMemorySize=2G -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap"
      dockerPort: 5003
      nexusPort: 8081
      serviceType: NodePort
      livenessProbe:
        failureThreshold: 6
        initialDelaySeconds: 30
        path: /
        periodSeconds: 30
      readinessProbe:
        failureThreshold: 6
        initialDelaySeconds: 30
        path: /
        periodSeconds: 30
      resources:
        ## Based on https://support.sonatype.com/hc/en-us/articles/115006448847#mem
        ## and https://twitter.com/analytically/status/894592422382063616:
        ##   Xms == Xmx
        ##   Xmx <= 4G
        ##   MaxDirectMemory >= 2G
        ##   Xmx + MaxDirectMemory <= RAM * 2/3 (hence the request for 4800Mi)
        ##   MaxRAMFraction=1 is not being set as it would allow the heap
        ##     to use all the available memory.
        # cpu: 250m
        # memory: 4800Mi
        limits:
          cpu: 1
          memory: 4800Mi
        requests:
          cpu: 500m
          memory: 4800Mi

    nexusProxy:
      imageName: quay.io/travelaudience/docker-nexus-proxy
      imageTag: 2.1.0
      imagePullPolicy: IfNotPresent
      env:
        cloudIamAuthEnabled: false
        enforceHttps: true
        nexusDockerHost: dcr.digimind.tech
        nexusHttpHost: nexus.digimind.tech
      port: 8080
      resources:
        limits:
          cpu: 200m
          memory: 1024Mi
        requests:
          cpu: 100m
          memory: 256Mi

    persistence:
      accessMode: ReadWriteOnce
      enabled: true
      storageClass: nfs-client
      storageSize: 500Gi

    nexusBackup:
      enabled: false
      imageName: quay.io/travelaudience/docker-nexus-backup
      imageTag: 1.2.0
      imagePullPolicy: IfNotPresent
      env:
        targetBucket: null
      nexusAdminPassword: Wse45Tgb!
      persistence:
        enabled: true
        existingClaim: nexus-backup

    ingress:
      enabled: false
      annotations:
        certmanager.k8s.io/acme-challenge-type: dns01
        certmanager.k8s.io/acme-dns01-provider: digimind.tech
        certmanager.k8s.io/cluster-issuer: letsencrypt-d-rdlabs
        kubernetes.io/ingress.allow-http: true
        kubernetes.io/ingress.class: nginx
        kubernetes.io/tls-acme: "true"
      path: /
      tls:
        enabled: false
        secretName: nexus-tls
